# Script: Configure-ExploitGuard.ps1
# Purpose: Configure Windows Defender Exploit Guard and Attack Surface Reduction (ASR) rules
# Framework Alignment: Microsoft Security Baseline, ASD Essential Eight
# Requires: Administrator privileges, Windows Defender module

<#
.SYNOPSIS
    Configures Windows Defender Exploit Guard and Attack Surface Reduction rules.

.DESCRIPTION
    This script enables:
    - Exploit Protection (CFG, DEP, etc.)
    - Attack Surface Reduction (ASR) rules
    - Network Protection
    
    ASR rules start in "Warn" (Audit) mode for initial deployment, then can be switched to "Block" mode.

.NOTES
    - ASR rules should be deployed in Audit mode first (30 days recommended)
    - Review ASR logs before switching to Block mode
    - Some rules may impact legitimate applications
    - Framework: Microsoft Security Baseline, ASD Essential Eight Maturity Level 2

.EXAMPLE
    .\Configure-ExploitGuard.ps1 -ASRMode Warn
    .\Configure-ExploitGuard.ps1 -ASRMode Block  # After audit period
#>

[CmdletBinding()]
param(
    [Parameter(Mandatory=$false)]
    [ValidateSet("Warn", "Block", "Audit")]
    [string]$ASRMode = "Warn",  # Start with Warn (Audit) mode
    
    [switch]$WhatIf
)

#Requires -RunAsAdministrator

$ErrorActionPreference = 'Continue'  # Continue on errors to attempt all operations

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "Exploit Guard & ASR Configuration" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""

# ASR Rule GUIDs and names
$ASRRules = @{
    "BE9BA2D9-53EA-4CDC-84E5-9B1EEEE46550" = "Block executable content from email client and webmail"
    "D4F940AB-401B-4EFC-AADC-AD5F3C50688A" = "Block Office applications from creating child processes"
    "3B576869-A4EC-4529-8536-B80A7769E899" = "Block Office applications from creating executable content"
    "75668C1F-73B5-4CF0-BB93-3ECF5CB7CC84" = "Block Office applications from injecting code into other processes"
    "D3E037E1-3EB8-4C12-9814-7B0F0C0F4E50" = "Block JavaScript or VBScript from launching downloaded executable content"
    "5BEB7EFE-FD9A-4556-801D-275E5FFC04CC" = "Block execution of potentially obfuscated scripts"
    "92E97FA1-2EDF-4476-BDD6-9DD0B4DDDC7B" = "Block Office macro code from the Internet"
    "01443614-CD74-433A-B99E-2ECDC07BFC25" = "Block executable files from running unless they meet a prevalence, age, or trusted list criterion"
    "B2B3F03D-6A65-4F7B-9A0C-3EBE1C1C3B3C" = "Block untrusted and unsigned processes that run from USB"
    "26190899-1603-49E8-8B27-EB1E0A1B069B" = "Block Adobe Reader from creating child processes"
    "7674BA52-37EB-4A4F-A9A1-F0F9A1619A2C" = "Block persistence through WMI event subscription"
    "D1E49A11-9217-47CD-93B9-53328B74A957" = "Block process creations originating from PSExec and WMI commands"
}

# ASR Mode values: 0 = Disabled, 1 = Block, 2 = Warn (Audit), 6 = Warn (Audit) - same as 2
$ASRModeValue = switch ($ASRMode) {
    "Block" { 1 }
    "Warn" { 2 }
    "Audit" { 2 }
    default { 2 }
}

Write-Host "ASR Mode: $ASRMode (Value: $ASRModeValue)" -ForegroundColor Yellow
Write-Host "Note: Starting in $ASRMode mode. Review logs before switching to Block mode." -ForegroundColor Yellow
Write-Host ""

try {
    # Check if Windows Defender is available
    try {
        $defenderStatus = Get-MpComputerStatus -ErrorAction Stop
        Write-Host "Windows Defender is available." -ForegroundColor Green
    } catch {
        Write-Error "Windows Defender is not available. This script requires Windows Defender."
        exit 1
    }
    
    Write-Host "Configuring Exploit Protection..." -ForegroundColor Yellow
    
    # Enable Exploit Protection system-wide
    # Note: Exploit Protection is typically configured via GPO or Intune
    # This script enables the feature, but detailed configuration is done via GPO
    if ($WhatIf) {
        Write-Host "[WHATIF] Would enable Exploit Protection" -ForegroundColor Green
        Write-Host "[WHATIF] Note: Detailed Exploit Protection settings should be configured via GPO" -ForegroundColor Green
    } else {
        Write-Host "  Exploit Protection is enabled by default on Windows Server 2025" -ForegroundColor Gray
        Write-Host "  Note: Configure Exploit Protection policies via GPO (see GPO-Configuration-Tables.md)" -ForegroundColor Yellow
    }
    
    Write-Host "`nConfiguring Attack Surface Reduction (ASR) rules..." -ForegroundColor Yellow
    
    # Configure each ASR rule
    foreach ($ruleGUID in $ASRRules.Keys) {
        $ruleName = $ASRRules[$ruleGUID]
        
        if ($WhatIf) {
            Write-Host "[WHATIF] Would set ASR rule: $ruleName" -ForegroundColor Green
            Write-Host "[WHATIF]   GUID: $ruleGUID" -ForegroundColor Green
            Write-Host "[WHATIF]   Mode: $ASRMode ($ASRModeValue)" -ForegroundColor Green
        } else {
            try {
                # Set ASR rule using Set-MpPreference
                # Note: ASR rules are configured via the -AttackSurfaceReductionRules_Ids and -AttackSurfaceReductionRules_Actions parameters
                # However, the preferred method is using Add-MpPreference with -AttackSurfaceReductionRules_Ids
                
                # Get current ASR rules
                $currentPrefs = Get-MpPreference -ErrorAction Stop
                $currentRuleIds = $currentPrefs.AttackSurfaceReductionRules_Ids
                $currentRuleActions = $currentPrefs.AttackSurfaceReductionRules_Actions
                
                # Check if rule already exists
                $ruleIndex = -1
                if ($currentRuleIds) {
                    $ruleIndex = [array]::IndexOf($currentRuleIds, $ruleGUID)
                }
                
                if ($ruleIndex -ge 0) {
                    # Update existing rule
                    $currentRuleActions[$ruleIndex] = $ASRModeValue
                    Set-MpPreference -AttackSurfaceReductionRules_Ids $currentRuleIds -AttackSurfaceReductionRules_Actions $currentRuleActions -ErrorAction Stop
                    Write-Host "  Updated: $ruleName (Mode: $ASRMode)" -ForegroundColor Gray
                } else {
                    # Add new rule
                    if ($currentRuleIds) {
                        $newRuleIds = $currentRuleIds + $ruleGUID
                        $newRuleActions = $currentRuleActions + $ASRModeValue
                    } else {
                        $newRuleIds = @($ruleGUID)
                        $newRuleActions = @($ASRModeValue)
                    }
                    Set-MpPreference -AttackSurfaceReductionRules_Ids $newRuleIds -AttackSurfaceReductionRules_Actions $newRuleActions -ErrorAction Stop
                    Write-Host "  Added: $ruleName (Mode: $ASRMode)" -ForegroundColor Gray
                }
            } catch {
                Write-Warning "Failed to configure ASR rule $ruleName ($ruleGUID): $_"
            }
        }
    }
    
    # Enable Network Protection
    Write-Host "`nConfiguring Network Protection..." -ForegroundColor Yellow
    if ($WhatIf) {
        Write-Host "[WHATIF] Would enable Network Protection in Block mode" -ForegroundColor Green
    } else {
        Set-MpPreference -EnableNetworkProtection Enabled -ErrorAction SilentlyContinue
        Write-Host "  Enabled Network Protection" -ForegroundColor Gray
    }
    
    if (-not $WhatIf) {
        Write-Host "`nVerifying ASR configuration..." -ForegroundColor Yellow
        $prefs = Get-MpPreference
        $asrRules = $prefs.AttackSurfaceReductionRules_Ids
        $asrActions = $prefs.AttackSurfaceReductionRules_Actions
        
        if ($asrRules) {
            Write-Host "`nConfigured ASR Rules:" -ForegroundColor Cyan
            for ($i = 0; $i -lt $asrRules.Count; $i++) {
                $ruleGUID = $asrRules[$i]
                $ruleAction = $asrActions[$i]
                $ruleName = if ($ASRRules.ContainsKey($ruleGUID)) { $ASRRules[$ruleGUID] } else { "Unknown rule" }
                $actionName = switch ($ruleAction) {
                    0 { "Disabled" }
                    1 { "Block" }
                    2 { "Warn/Audit" }
                    default { "Unknown" }
                }
                Write-Host "  $ruleName : $actionName" -ForegroundColor Gray
            }
        } else {
            Write-Warning "No ASR rules found. Rules may not have been applied correctly."
        }
        
        Write-Host "`nASR Event Log Location:" -ForegroundColor Cyan
        Write-Host "  Windows Defender > Operational" -ForegroundColor Gray
        Write-Host "  Event ID 1121, 1122 (ASR rule triggered)" -ForegroundColor Gray
        Write-Host "`nReview ASR logs for 30 days before switching to Block mode." -ForegroundColor Yellow
    }
    
} catch {
    Write-Error "Error configuring Exploit Guard/ASR: $_"
    throw
}

Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "Exploit Guard & ASR Configuration Complete" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "`nNext Steps:" -ForegroundColor Yellow
Write-Host "1. Monitor ASR logs in Event Viewer (Windows Defender > Operational)" -ForegroundColor White
Write-Host "2. Review triggered events for 30 days" -ForegroundColor White
Write-Host "3. Add exceptions for legitimate applications if needed" -ForegroundColor White
Write-Host "4. Switch to Block mode: .\Configure-ExploitGuard.ps1 -ASRMode Block" -ForegroundColor White

